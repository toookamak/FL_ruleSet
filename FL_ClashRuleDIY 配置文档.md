## ğŸ¤– Assistant

# FL_ClashRuleDIY é…ç½®æ–‡æ¡£

## 1. ç»“æ„è¯´æ˜

### 1.1 åˆ†æµè§„åˆ™é€»è¾‘è¯´æ˜

æœ¬é…ç½®é‡‡ç”¨å±‚çº§åŒ–åˆ†æµæ¶æ„ï¼ŒæŒ‰ç…§ä»¥ä¸‹ä¼˜å…ˆçº§é¡ºåºè¿›è¡Œæµé‡å¤„ç†ï¼š

1. **å®‰å…¨é˜²æŠ¤å±‚**ï¼šå¹¿å‘Šæ‹¦æˆªã€è·Ÿè¸ªå™¨æ‹¦æˆªç­‰å®‰å…¨è§„åˆ™ä¼˜å…ˆå¤„ç†
2. **åº”ç”¨ä¸“ç”¨å±‚**ï¼šé’ˆå¯¹ç‰¹å®šåº”ç”¨å’ŒæœåŠ¡çš„ä¼˜åŒ–è·¯ç”±ï¼ˆå¦‚AIæœåŠ¡ã€è§†é¢‘æœåŠ¡ç­‰ï¼‰
3. **æµé‡ç®¡ç†å±‚**ï¼šå¤§æµé‡ä¼ è¾“ã€ä¸‹è½½ç­‰ç‰¹æ®Šæµé‡å¤„ç†
4. **è‡ªå®šä¹‰è§„åˆ™å±‚**ï¼šç”¨æˆ·è‡ªå®šä¹‰çš„ä»£ç†å’Œç›´è¿è§„åˆ™
5. **åŸºç¡€è·¯ç”±å±‚**ï¼šå›½å†…ç›´è¿ã€å›½é™…ä»£ç†çš„åŸºç¡€è·¯ç”±
6. **é»˜è®¤è·¯ç”±å±‚**ï¼šæœªåŒ¹é…æµé‡çš„æœ€ç»ˆå¤„ç†

### 1.2 åˆ†æµè§„åˆ™ç»“æ„

é…ç½®é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š

```
é…ç½®ç®¡ç†ä¸­å¿ƒ (å…¨å±€å‚æ•°è®¾ç½®)
â”œâ”€â”€ ç­–ç•¥ç»„å‘½åå¸¸é‡ (ç»Ÿä¸€å‘½åç®¡ç†)
â”œâ”€â”€ ç¼“å­˜ç®¡ç† (æ€§èƒ½ä¼˜åŒ–)
â”œâ”€â”€ å›¾æ ‡é…ç½® (å¯è§†åŒ–ç•Œé¢)
â”œâ”€â”€ ä¸»å…¥å£å‡½æ•° (é…ç½®å¤„ç†æµç¨‹)
â”œâ”€â”€ åŸºç¡€è®¾ç½®æ¨¡å— (æ ¸å¿ƒè¿è¡Œå‚æ•°)
â”œâ”€â”€ æµé‡å—…æ¢è®¾ç½® (åŠ å¯†æµé‡è¯†åˆ«)
â”œâ”€â”€ ä»£ç†ç»„é…ç½®æ¨¡å— (ç­–ç•¥ç»„ç”Ÿæˆ)
â”‚   â”œâ”€â”€ åœ°åŒºé…ç½®
â”‚   â”œâ”€â”€ èŠ‚ç‚¹åˆ†ç±»å¤„ç†
â”‚   â”œâ”€â”€ æ ¸å¿ƒç­–ç•¥ç»„
â”‚   â”œâ”€â”€ åœ°åŒºå…¥å£ç­–ç•¥ç»„
â”‚   â”œâ”€â”€ åœ°åŒºç­–ç•¥ç»„
â”‚   â”œâ”€â”€ çº¿è·¯ç‰¹æ€§ç­–ç•¥ç»„
â”‚   â”œâ”€â”€ æœåŠ¡ç­–ç•¥ç»„
â”‚   â”œâ”€â”€ æµé‡ç®¡ç†ç­–ç•¥ç»„
â”‚   â”œâ”€â”€ è‡ªå®šä¹‰è§„åˆ™ç­–ç•¥ç»„
â”‚   â””â”€â”€ é»˜è®¤è·¯ç”±ç­–ç•¥ç»„
â”œâ”€â”€ è§„åˆ™é…ç½®æ¨¡å— (è§„åˆ™åŒ¹é…é¡ºåº)
â”œâ”€â”€ è§„åˆ™æä¾›å™¨é…ç½® (å¤–éƒ¨è§„åˆ™æº)
â”œâ”€â”€ è¾…åŠ©å‡½æ•° (å·¥å…·æ–¹æ³•)
â”œâ”€â”€ DNSé…ç½®æ¨¡å— (åŸŸåè§£æ)
â””â”€â”€ TUNé…ç½®æ¨¡å— (éš§é“åŠŸèƒ½)
```

### 1.3 ä¸»è¦è®¾ç½®å‚æ•°è¯´æ˜

#### 1.3.1 æ ¸å¿ƒè¿è¡Œå‚æ•°

| å‚æ•°å | é»˜è®¤å€¼ | è¯´æ˜ | æ¨èå€¼ |
|--------|--------|------|--------|
| mixed-port | 7890 | HTTP/SOCKSæ··åˆç«¯å£ | 7890-7899 |
| allow-lan | true | å…è®¸å±€åŸŸç½‘è®¿é—® | true/false |
| tcp-concurrent | true | TCPå¹¶å‘è¿æ¥ | true/false |
| ipv6 | true | IPv6æ”¯æŒ | true/false |

#### 1.3.2 DNSé…ç½®å‚æ•°

| å‚æ•°å | é»˜è®¤å€¼ | è¯´æ˜ | æ¨èå€¼ |
|--------|--------|------|--------|
| enhanced-mode | fake-ip | DNSå¢å¼ºæ¨¡å¼ | fake-ip/dns-mapping |
| fake-ip-range | 198.18.0.1/16 | è™šå‡IPèŒƒå›´ | ä¿æŒé»˜è®¤ |
| nameserver | å¤šä¸ªDNSæœåŠ¡å™¨ | ä¸»è¦DNSè§£ææœåŠ¡å™¨ | æ ¹æ®ç½‘ç»œç¯å¢ƒé€‰æ‹© |

#### 1.3.3 ç­–ç•¥ç»„ç±»å‹å‚æ•°

| ç±»å‹ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| select | æ‰‹åŠ¨é€‰æ‹© | ç”¨æˆ·äº¤äº’é€‰æ‹© |
| url-test | å»¶è¿Ÿæµ‹è¯• | è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹ |
| fallback | æ•…éšœè½¬ç§» | ä¸»å¤‡åˆ‡æ¢ |
| load-balance | è´Ÿè½½å‡è¡¡ | å¤šèŠ‚ç‚¹è´Ÿè½½åˆ†æ‹… |

#### 1.3.4 æ›´æ–°é—´éš”å‚æ•°

| ç±»å‹ | é»˜è®¤å€¼(ç§’) | è¯´æ˜ | æ¨èèŒƒå›´ |
|------|------------|------|----------|
| DEFAULT | 86400 | ä¸€èˆ¬è§„åˆ™æ›´æ–° | 3600-172800 |
| CRITICAL | 86400 | å…³é”®è§„åˆ™æ›´æ–° | 1800-86400 |
| STATIC | 86400 | é™æ€è§„åˆ™æ›´æ–° | 86400-604800 |

### 1.4 ç­–ç•¥ç»„åˆ†ç±»è¯´æ˜

#### 1.4.1 æŒ‰åŠŸèƒ½åˆ†ç±»

1. **æ ¸å¿ƒè·¯ç”±ç»„**ï¼šæä¾›ä¸»è¦çš„ä»£ç†æ¨¡å¼é€‰æ‹©
2. **åœ°åŒºé€‰æ‹©ç»„**ï¼šæŒ‰åœ°ç†ä½ç½®åˆ†ç±»çš„èŠ‚ç‚¹ç»„
3. **çº¿è·¯ç‰¹æ€§ç»„**ï¼šç‰¹æ®Šçº¿è·¯ç±»å‹ï¼ˆå®¶å®½ã€ä½å€ç‡ç­‰ï¼‰
4. **æœåŠ¡ä¸“ç”¨ç»„**ï¼šé’ˆå¯¹ç‰¹å®šæœåŠ¡ä¼˜åŒ–çš„è·¯ç”±ç»„
5. **æµé‡ç®¡ç†ç»„**ï¼šå¤§æµé‡å’Œç‰¹æ®Šæµé‡å¤„ç†
6. **è‡ªå®šä¹‰è§„åˆ™ç»„**ï¼šç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™
7. **é»˜è®¤è·¯ç”±ç»„**ï¼šå…œåº•çš„æµé‡å¤„ç†

#### 1.4.2 æŒ‰å¯è§æ€§åˆ†ç±»

1. **ç”¨æˆ·å¯è§ç»„**ï¼šæä¾›ç»™ç”¨æˆ·é€‰æ‹©çš„ç­–ç•¥ç»„
2. **åå°è¿è¡Œç»„**ï¼šè‡ªåŠ¨è¿è¡Œçš„ç­–ç•¥ç»„ï¼ˆhidden=trueï¼‰

## 2. ä½¿ç”¨è¯´æ˜

### 2.1 æ¨¡å—åˆ†ç±»

#### 2.1.1 é…ç½®ç®¡ç†ä¸­å¿ƒï¼ˆç¬¬17-50è¡Œï¼‰

**åŠŸèƒ½è¯´æ˜**ï¼šé›†ä¸­ç®¡ç†ç³»ç»Ÿæ‰€æœ‰å¯é…ç½®å‚æ•°ã€‚

**ä¸»è¦å‚æ•°ä¿®æ”¹æ–¹æ³•**ï¼š
- **TEST_URL**ï¼ˆç¬¬21è¡Œï¼‰ï¼šä¿®æ”¹å»¶è¿Ÿæµ‹è¯•URL
```javascript
  // åŸé…ç½®
  TEST_URL: "http://www.gstatic.com/generate_204"
  // ä¿®æ”¹ä¸ºCloudflareæµ‹è¯•ç‚¹
  TEST_URL: "http://cp.cloudflare.com/generate_204"
  ```

- **UPDATE_INTERVALS**ï¼ˆç¬¬30-34è¡Œï¼‰ï¼šè°ƒæ•´è§„åˆ™æ›´æ–°é¢‘ç‡
  ```javascript
  // æ›´é¢‘ç¹æ›´æ–°ï¼ˆæ¯å°æ—¶ï¼‰
  DEFAULT: 3600
  // æ›´èŠ‚çœæµé‡ï¼ˆæ¯å‘¨ï¼‰
  DEFAULT: 604800
  ```

#### 2.1.2 ç­–ç•¥ç»„å‘½åï¼ˆç¬¬53-73è¡Œï¼‰

**åŠŸèƒ½è¯´æ˜**ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç­–ç•¥ç»„åç§°ï¼Œä¾¿äºç»´æŠ¤ã€‚

**æ·»åŠ æ–°ç­–ç•¥ç»„**ï¼š
```javascript
// åœ¨ç¬¬53è¡Œåæ·»åŠ 
const GAME_SERVICE = "æ¸¸æˆæœåŠ¡"; // æ–°å¢æ¸¸æˆæœåŠ¡ç­–ç•¥ç»„
```

#### 2.1.3 å›¾æ ‡é…ç½®ï¼ˆç¬¬87-132è¡Œï¼‰

**åŠŸèƒ½è¯´æ˜**ï¼šç®¡ç†ç­–ç•¥ç»„å›¾æ ‡ï¼Œæ”¯æŒå¤šCDNæºã€‚

**ä¿®æ”¹å›¾æ ‡æº**ï¼š
```javascript
// åœ¨ç¬¬41è¡Œä¿®æ”¹CDNæº
CDN_SOURCES: {
 PRIMARY: "https://your-cdn.com/icons/", // ä½¿ç”¨è‡ªå®šä¹‰CDN
 BACKUP: "https://backup-cdn.com/icons/",
 LOCAL: "./custom-icons/"
}
```

#### 2.1.4 åŸºç¡€è®¾ç½®æ¨¡å—ï¼ˆç¬¬183-207è¡Œï¼‰

**åŠŸèƒ½è¯´æ˜**ï¼šé…ç½®Clashæ ¸å¿ƒè¿è¡Œå‚æ•°ã€‚

**å¸¸è§ä¿®æ”¹**ï¼š
- **ç«¯å£å·ä¿®æ”¹**ï¼ˆç¬¬185è¡Œï¼‰ï¼š
  ```javascript
  "mixed-port": 8888  // æ”¹ä¸º8888ç«¯å£
  ```

- **åœ°ç†æ•°æ®æº**ï¼ˆç¬¬190-193è¡Œï¼‰ï¼š
  ```javascript
  "geox-url": {
      "geoip": "ä½ çš„geoipæ•°æ®æº",
      "geosite": "ä½ çš„geositeæ•°æ®æº"
  }
  ```

#### 2.1.5 ä»£ç†ç»„é…ç½®æ¨¡å—ï¼ˆç¬¬264-534è¡Œï¼‰

**åŠŸèƒ½è¯´æ˜**ï¼šåŠ¨æ€ç”Ÿæˆç­–ç•¥ç»„ï¼Œæ˜¯é…ç½®çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚

**æ·»åŠ æ–°åœ°åŒºæ”¯æŒ**ï¼ˆç¬¬290-312è¡Œï¼‰ï¼š
```javascript
// åœ¨createRegionalConfigå‡½æ•°ä¸­æ·»åŠ 
{
 code: "KR",
 name: "éŸ©å›½",
 icon: ICONS.KR, // éœ€è¦åœ¨å›¾æ ‡é…ç½®ä¸­æ·»åŠ 
 regex: /(éŸ©å›½|KR|Korea|ğŸ‡°ğŸ‡·)/i
}
```

**æ·»åŠ æ–°æœåŠ¡ç­–ç•¥ç»„**ï¼ˆç¬¬423-494è¡Œï¼‰ï¼š
```javascript
// åœ¨createServiceGroupså‡½æ•°ä¸­æ·»åŠ è¿”å›æ•°ç»„
createProxyGroup("æ¸¸æˆæœåŠ¡", "select", {
 category: CONFIG_MANAGER.GROUP_CATEGORY.SERVICE,
 proxies: serviceOptions, // å¤ç”¨ç°æœ‰é€‰é¡¹
 icon: ICONS.GAME // éœ€è¦é¢„å…ˆå®šä¹‰å›¾æ ‡
})
```

#### 2.1.6 è§„åˆ™é…ç½®æ¨¡å—ï¼ˆç¬¬537-623è¡Œï¼‰

**åŠŸèƒ½è¯´æ˜**ï¼šé…ç½®è§„åˆ™åŒ¹é…é¡ºåºå’Œå¯¹åº”ç­–ç•¥ç»„ã€‚

**æ·»åŠ è‡ªå®šä¹‰è§„åˆ™**ï¼ˆç¬¬542-545è¡Œï¼‰ï¼š
```javascript
// åœ¨customRulesæ•°ç»„ä¸­æ·»åŠ 
const customRules = [
 "DOMAIN-SUFFIX,example.com,å¹³å°æœåŠ¡", // ç‰¹å®šåŸŸåèµ°å¹³å°æœåŠ¡
 "IP-CIDR,192.168.1.0/24,DIRECT" // ç‰¹å®šIPæ®µç›´è¿
];
```

#### 2.1.7 è§„åˆ™æä¾›å™¨é…ç½®ï¼ˆç¬¬626-905è¡Œï¼‰

**åŠŸèƒ½è¯´æ˜**ï¼šé…ç½®å¤–éƒ¨è§„åˆ™é›†çš„æ¥æºå’Œæ›´æ–°è®¾ç½®ã€‚

**æ·»åŠ æ–°è§„åˆ™é›†**ï¼š
```javascript
// åœ¨createRuleProviderså‡½æ•°ä¸­æ·»åŠ 
NewRuleSet: createRuleProviderConfig(
 "è§„åˆ™é›†URL",
 "./ruleset/æœ¬åœ°è·¯å¾„.yaml",
 CONFIG_MANAGER.UPDATE_INTERVALS.DEFAULT
)
```

### 2.2 ä¿®æ”¹ç°æœ‰é…ç½®

#### 2.2.1 ä¿®æ”¹åœ°åŒºåŒ¹é…è§„åˆ™

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬290-312è¡Œ `createRegionalConfig` å‡½æ•°

```javascript
// åŸé…ç½®ï¼ˆä»…åŒ¹é…é¦™æ¸¯ï¼‰
regex: /(é¦™æ¸¯|HK|Hong Kong|ğŸ‡­ğŸ‡°)/i
// æ‰©å±•åŒ¹é…ï¼ˆåŒ…æ‹¬æ›´å¤šå˜ä½“ï¼‰
regex: /(é¦™æ¸¯|HK|Hong Kong|ğŸ‡­ğŸ‡°|æ¸¯æœ)/i
```

#### 2.2.2 è°ƒæ•´ç­–ç•¥ç»„ä¼˜å…ˆçº§

**ä¿®æ”¹ä½ç½®**ï¼šç¬¬344-356è¡Œ `createBaseOptions` å‡½æ•°

```javascript
// åŸé…ç½®é¡ºåº
const baseOptions = [
 ...COUNTRY_REGIONS.filter(r => availableRegions.has(r.name)).map(r => `${r.name} Â· è‡ªåŠ¨é€‰æ‹©`),
 "å»¶è¿Ÿä¼˜é€‰",
 "æ•…éšœè½¬ç§»",
 // ...
];

// è°ƒæ•´ä¸ºæ•…éšœè½¬ç§»ä¼˜å…ˆ
const baseOptions = [
 "æ•…éšœè½¬ç§»", // æå‰
 "å»¶è¿Ÿä¼˜é€‰",
 ...COUNTRY_REGIONS.filter(r => availableRegions.has(r.name)).map(r => `${r.name} Â· è‡ªåŠ¨é€‰æ‹©`),
 // ...
];
```

### 2.3 æ·»åŠ æ–°åŠŸèƒ½

#### 2.3.1 æ·»åŠ æ–°çš„ç­–ç•¥ç»„ç±»å‹

1. **å®šä¹‰å¸¸é‡**ï¼ˆç¬¬53è¡Œåï¼‰ï¼š
   ```javascript
   const SOCIAL_MEDIA = "ç¤¾äº¤åª’ä½“";
   ```

2. **æ·»åŠ å›¾æ ‡**ï¼ˆç¬¬87è¡Œåï¼‰ï¼š
   ```javascript
   SOCIAL: CONFIG_MANAGER.CDN_SOURCES.PRIMARY + "Social.png"
   ```

3. **åˆ›å»ºç­–ç•¥ç»„å‡½æ•°**ï¼ˆç¬¬500è¡Œåï¼‰ï¼š
   ```javascript
   function createSocialMediaGroups() {
       return createProxyGroup(SOCIAL_MEDIA, "select", {
           category: CONFIG_MANAGER.GROUP_CATEGORY.SERVICE,
           proxies: serviceOptions,
           icon: ICONS.SOCIAL
       });
   }
   ```

4. **é›†æˆåˆ°ä¸»æµç¨‹**ï¼ˆç¬¬335è¡Œé™„è¿‘ï¼‰ï¼š
   ```javascript
   const socialGroups = createSocialMediaGroups();
   const allGroups = [
       // ...
       socialGroups,  // æ·»åŠ åˆ°åˆé€‚ä½ç½®
       // ...
   ];
   ```

#### 2.3.2 æ·»åŠ æ–°çš„è§„åˆ™é›†

1. **åœ¨è§„åˆ™æä¾›å™¨ä¸­æ·»åŠ **ï¼ˆç¬¬626è¡Œåï¼‰ï¼š
   ```javascript
   SocialRules: {
       type: "http",
       behavior: "classical",
       format: "text",
       interval: CONFIG_MANAGER.UPDATE_INTERVALS.STATIC,
       url: "ç¤¾äº¤è§„åˆ™é›†URL",
       path: "./ruleset/social.yaml"
   }
   ```

2. **åœ¨è§„åˆ™é…ç½®ä¸­ä½¿ç”¨**ï¼ˆç¬¬550è¡Œåï¼‰ï¼š
   ```javascript
   `RULE-SET,SocialRules,${SOCIAL_MEDIA}`
   ```

## 3. ç²¾ç®€æ ¸å¿ƒæ¡†æ¶

```javascript
// FL_ClashRuleDIY_Core.js - æ ¸å¿ƒæ¡†æ¶æ¨¡æ¿
// ç‰ˆæœ¬ï¼šv1.0.0
// è¯´æ˜ï¼šä»…åŒ…å«æ ¸å¿ƒæ¡†æ¶å’Œæ¨¡å—ç»“æ„

// ===================== é…ç½®ç®¡ç†ä¸­å¿ƒ =====================
/**
 * å…¨å±€é…ç½®ç®¡ç†å™¨ - é›†ä¸­ç®¡ç†å¯é…ç½®å‚æ•°
*/
const CONFIG_MANAGER = {
 // åŸºç¡€é…ç½®å¸¸é‡
 TEST_URL: "http://www.gstatic.com/generate_204", // å»¶è¿Ÿæµ‹è¯•URL
 REGION_TEST_URLS: { // åœ°åŒºæµ‹è¯•URL
 HK: "http://www.gstatic.com/generate_204",
 SG: "http://www.gstatic.com/generate_204",
 JP: "http://www.gstatic.com/generate_204",
 US: "http://www.gstatic.com/generate_204"
 },

 // æ›´æ–°é—´éš”é…ç½®
 UPDATE_INTERVALS: {
 DEFAULT: 86400, // 24å°æ—¶æ›´æ–°é—´éš”
 CRITICAL: 86400, // å…³é”®è§„åˆ™æ›´æ–°é—´éš”
 STATIC: 86400 // é™æ€è§„åˆ™æ›´æ–°é—´éš”
 },

 // ç­–ç•¥ç»„åˆ†ç±»é…ç½®
 GROUP_CATEGORY: {
 CORE: "æ ¸å¿ƒè·¯ç”±", // æ ¸å¿ƒè·¯ç”±ç­–ç•¥ç»„
 REGION_ENTRY: "åœ°åŒºé€‰æ‹©", // åœ°åŒºé€‰æ‹©å…¥å£ç­–ç•¥ç»„
 REGION: "å…·ä½“åœ°åŒº", // å…·ä½“åœ°åŒºç­–ç•¥ç»„
 LINE_TYPE: "çº¿è·¯ç‰¹æ€§", // çº¿è·¯ç‰¹æ€§ç­–ç•¥ç»„
 SERVICE: "æœåŠ¡ä¸“ç”¨", // æœåŠ¡ä¸“ç”¨ç­–ç•¥ç»„
 TRAFFIC: "æµé‡ç®¡ç†", // æµé‡ç®¡ç†ç­–ç•¥ç»„
 CUSTOM: "è‡ªå®šä¹‰è§„åˆ™", // è‡ªå®šä¹‰è§„åˆ™ç­–ç•¥ç»„
 DEFAULT_ROUTE: "é»˜è®¤è·¯ç”±" // é»˜è®¤è·¯ç”±ç­–ç•¥ç»„
 }
};

// ===================== ç­–ç•¥ç»„å‘½åå¸¸é‡ =====================
/**
 * ç­–ç•¥ç»„åç§°å®šä¹‰ - ä¾¿äºç»Ÿä¸€ç®¡ç†å’Œç»´æŠ¤
*/
const GLOBAL_ROUTING = "ä»£ç†æ¨¡å¼"; // æ ¸å¿ƒä»£ç†æ¨¡å¼å…¥å£
const MANUAL_REGION_SELECT = "æ‰‹åŠ¨é€‰æ‹© (åœ°åŒº)"; // æ‰‹åŠ¨é€‰æ‹©åœ°åŒºå…¥å£
const RESIDENTIAL_LINE = "å®¶å®½/åŸç”Ÿçº¿è·¯"; // å®¶å®½/åŸç”ŸIPçº¿è·¯
const LOW_RATE_NODE = "ä½å€ç‡èŠ‚ç‚¹"; // ä½å€ç‡ä¼˜æƒ èŠ‚ç‚¹
const CUSTOM_PROXY_RULE = "è‡ªå®šä¹‰ä»£ç†è§„åˆ™"; // ç”¨æˆ·è‡ªå®šä¹‰ä»£ç†è§„åˆ™
const CUSTOM_DIRECT_RULE = "è‡ªå®šä¹‰ç›´è¿è§„åˆ™"; // ç”¨æˆ·è‡ªå®šä¹‰ç›´è¿è§„åˆ™
const DOMESTIC_TRAFFIC = "å›½å†…æµé‡"; // å›½å†…ç½‘ç»œæµé‡
const GLOBAL_TRAFFIC = "å›½é™…æµé‡"; // å›½é™…ç½‘ç»œæµé‡

// ===================== ç¼“å­˜ç®¡ç† =====================
/**
 * å…¨å±€ç¼“å­˜å¯¹è±¡ - æé«˜æ€§èƒ½ï¼Œé¿å…é‡å¤è®¡ç®—
*/
const CACHE = {
 proxyGroups: null,
 availableRegions: null,
 residentialProxies: null,
 lowRateProxies: null,
 ruleProviders: null
};

// ===================== ä¸»å…¥å£å‡½æ•° =====================
/**
 * ä¸»å…¥å£å‡½æ•° - å¤„ç†Clashé…ç½®æ–‡ä»¶
 * @param {Object} params - Clashé…ç½®å‚æ•°å¯¹è±¡
 * @return {Object} å¤„ç†åçš„é…ç½®å‚æ•°å¯¹è±¡
*/
const main = (params) => {
 // æ£€æŸ¥é…ç½®ä¸­æ˜¯å¦åŒ…å«ä»£ç†ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç›´æ¥è¿”å›åŸé…ç½®
 if (!params.proxies) return params;

 // ä¾æ¬¡åº”ç”¨å„é¡¹é…ç½®è¦†ç›–ï¼ˆå¤„ç†é¡ºåºå¾ˆé‡è¦ï¼‰
 overwriteBasicOptions(params); // è¦†ç›–åŸºç¡€é…ç½®
 overwriteSniffer(params); // è¦†ç›–æµé‡å—…æ¢é…ç½®
 overwriteProxyGroups(params); // è¦†ç›–ä»£ç†ç»„é…ç½®
 overwriteRules(params); // è¦†ç›–è§„åˆ™é…ç½®
 overwriteDns(params); // è¦†ç›–DNSé…ç½®
 overwriteTunnel(params); // è¦†ç›–TUNé…ç½®

 // æ¸…ç†ç¼“å­˜ï¼Œé‡Šæ”¾å†…å­˜
 clearCache();

 // è¿”å›å¤„ç†å®Œæˆçš„é…ç½®å¯¹è±¡
 return params;
};

// ===================== ç¼“å­˜ç®¡ç†å‡½æ•° =====================
/**
 * æ¸…ç†ç¼“å­˜å‡½æ•° - é˜²æ­¢å†…å­˜æ³„æ¼
*/
function clearCache() {
 CACHE.proxyGroups = null;
 CACHE.availableRegions = null;
 CACHE.residentialProxies = null;
 CACHE.lowRateProxies = null;
 CACHE.ruleProviders = null;
}

// ===================== åŸºç¡€è®¾ç½®æ¨¡å— =====================
/**
 * è¦†ç›–åŸºç¡€é…ç½®é€‰é¡¹ - è®¾ç½®Clashæ ¸å¿ƒè¿è¡Œå‚æ•°
 * @param {Object} params - é…ç½®å‚æ•°å¯¹è±¡
*/
function overwriteBasicOptions(params) {
 Object.assign(params, {
 "mixed-port": 7890, // æ··åˆç«¯å£
 "allow-lan": true, // å…è®¸å±€åŸŸç½‘è®¿é—®
 "unified-delay": true, // å¯ç”¨ç»Ÿä¸€å»¶è¿Ÿè®¡ç®—
 "tcp-concurrent": true, // å¯ç”¨TCPå¹¶å‘è¿æ¥
 "geodata-mode": true, // å¯ç”¨åœ°ç†æ•°æ®æ¨¡å¼
 "geox-url": { // åœ°ç†æ•°æ®æ–‡ä»¶ä¸‹è½½URL
 "geoip": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip.dat",
 "geosite": "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat"
 },
 "fakeind-process-mode": "strict", // ä¸¥æ ¼æ¨¡å¼å¤„ç†è™šå‡æŒ‡æ ‡
 "global-client-fingerprint": "chrome", // å…¨å±€å®¢æˆ·ç«¯æŒ‡çº¹
 profile: { // é…ç½®æ–‡ä»¶ç›¸å…³è®¾ç½®
 "store-selected": true, // å­˜å‚¨ç”¨æˆ·é€‰æ‹©çš„ç­–ç•¥ç»„
 "store-fake-ip": true // å­˜å‚¨è™šå‡IPæ˜ å°„
 },
 ipv6: true, // å¯ç”¨IPv6æ”¯æŒ
 mode: "rule", // è¿è¡Œæ¨¡å¼ä¸ºè§„åˆ™æ¨¡å¼
 "skip-auth-prefixes": ["127.0.0.1/32"], // è·³è¿‡è®¤è¯çš„IPå‰ç¼€
 "lan-allowed-ips": ["0.0.0.0/0", "::/0"] // å…è®¸è®¿é—®çš„å±€åŸŸç½‘IPèŒƒå›´
 });
}

// ===================== æµé‡å—…æ¢è®¾ç½® =====================
/**
 * è¦†ç›–æµé‡å—…æ¢é…ç½® - è‡ªåŠ¨è¯†åˆ«å’Œå¤„ç†åŠ å¯†æµé‡
 * @param {Object} params - é…ç½®å‚æ•°å¯¹è±¡
*/
function overwriteSniffer(params) {
 params.sniffer = {
 enable: true, // å¯ç”¨æµé‡å—…æ¢
 "force-dns-mapping": true, // å¼ºåˆ¶DNSæ˜ å°„
 "parse-pure-ip": true, // è§£æçº¯IPæµé‡
 "override-destination": false, // ä¸è¦†ç›–ç›®æ ‡åœ°å€
 sniff: { // å—…æ¢åè®®é…ç½®
 HTTP: { // HTTPåè®®å—…æ¢
 ports: ["80", "443"], // ç›‘å¬80å’Œ443ç«¯å£
 "override-destination": false // ä¸è¦†ç›–HTTPç›®æ ‡
 },
 TLS: { // TLSåè®®å—…æ¢
 ports: ["443"] // ç›‘å¬443ç«¯å£
 }
 },
 "skip-domain": ["+.push.apple.com"], // è·³è¿‡å—…æ¢çš„åŸŸå
 "skip-dst-address": [ // è·³è¿‡å—…æ¢çš„ç›®æ ‡IPåœ°å€æ®µ
 // å¸¸è§çš„è·³è¿‡åœ°å€æ®µ
 ]
 };
}

// ===================== ä»£ç†ç»„é…ç½®æ¨¡å— =====================
/**
 * è¦†ç›–ä»£ç†ç»„é…ç½® - æ ¸å¿ƒç­–ç•¥ç»„é…ç½®å‡½æ•°
 * @param {Object} params - é…ç½®å‚æ•°å¯¹è±¡
*/
function overwriteProxyGroups(params) {
 // æ£€æŸ¥ç¼“å­˜
 if (CACHE.proxyGroups) {
 params["proxy-groups"] = CACHE.proxyGroups;
 params.__hasResidential = CACHE.residentialProxies && CACHE.residentialProxies.length > 0;
 params.__hasLowRate = CACHE.lowRateProxies && CACHE.lowRateProxies.length > 0;
 return;
 }

 // åœ°åŒºåˆ†ç»„é…ç½®
 const COUNTRY_REGIONS = createRegionalConfig();

 // è·å–æœ‰æ•ˆä»£ç†å’ŒèŠ‚ç‚¹åˆ†ç±»
 const { allProxies, availableRegions, residentialProxies, lowRateProxies,
 hasResidential, hasLowRate, hasOtherProxies } = processProxyNodes(params, COUNTRY_REGIONS);

 // å­˜å‚¨åˆ°ç¼“å­˜
 CACHE.residentialProxies = residentialProxies;
 CACHE.lowRateProxies = lowRateProxies;

 // åˆ›å»ºå„ç±»ç­–ç•¥ç»„
 const coreGroups = createCoreGroups(allProxies, COUNTRY_REGIONS, availableRegions, hasResidential, hasLowRate);
 const regionEntryGroups = createRegionEntryGroups(COUNTRY_REGIONS, availableRegions, hasResidential, hasLowRate);
 const { autoSelectGroups, manualSelectGroups, otherAutoGroup, otherManualGroup } =
 createRegionalGroups(params, COUNTRY_REGIONS, availableRegions);
 const lineTypeGroups = createLineTypeGroups(hasResidential, residentialProxies, hasLowRate, lowRateProxies);
 const customRuleGroups = createCustomRuleGroups(COUNTRY_REGIONS, availableRegions, hasResidential, hasLowRate, hasOtherProxies);
 const defaultRouteGroups = createDefaultRouteGroups(COUNTRY_REGIONS, availableRegions, hasResidential, hasLowRate, hasOtherProxies);

 // åˆå¹¶æ‰€æœ‰ä»£ç†ç»„
 const allGroups = [
 ...coreGroups,
 ...lineTypeGroups,
 ...customRuleGroups,
 ...defaultRouteGroups,
 ...regionEntryGroups,
 ...manualSelectGroups,
 ...autoSelectGroups,
 ...(otherManualGroup ? [otherManualGroup] : []),
 ...(otherAutoGroup ? [otherAutoGroup] : [])
 ];

 // å­˜å‚¨åˆ°ç¼“å­˜å’Œå‚æ•°
 CACHE.proxyGroups = allGroups;
 params["proxy-groups"] = allGroups;
 params.__hasResidential = hasResidential;
 params.__hasLowRate = hasLowRate;
}

/**
 * åˆ›å»ºåœ°åŒºé…ç½® - å®šä¹‰æ”¯æŒçš„åœ°åŒºåŠå…¶åŒ¹é…è§„åˆ™
*/
function createRegionalConfig() {
 return [
 {
 code: "HK", // åœ°åŒºä»£ç 
 name: "é¦™æ¸¯", // åœ°åŒºåç§°
 regex: /(é¦™æ¸¯|HK|Hong Kong|ğŸ‡­ğŸ‡°)/i // åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼
 },
 {
 code: "SG",
 name: "æ–°åŠ å¡",
 regex: /(æ–°åŠ å¡|ç‹®åŸ|SG|Singapore|ğŸ‡¸ğŸ‡¬)/i
 },
 {
 code: "JP",
 name: "æ—¥æœ¬",
 regex: /(æ—¥æœ¬|JP|Japan|ğŸ‡¯ğŸ‡µ)/i
 },
 {
 code: "US",
 name: "ç¾å›½",
 regex: /(ç¾å›½|US|USA|United States|America|ğŸ‡ºğŸ‡¸)/i
 }
 ];
}

/**
 * å¤„ç†ä»£ç†èŠ‚ç‚¹åˆ†ç±» - å¯¹ä»£ç†èŠ‚ç‚¹è¿›è¡Œåˆ†ç±»å’Œç­›é€‰
*/
function processProxyNodes(params, COUNTRY_REGIONS) {
 const PROXY_REGEX = /^(?!.*(?:è‡ªåŠ¨|æ•…éšœ|æµé‡|å®˜ç½‘|å¥—é¤|æœºåœº|è®¢é˜…|å¹´|æœˆ|å¤±è”|é¢‘é“|Traffic|Expire)).*$/;
 const allProxies = getProxiesByRegex(params, PROXY_REGEX);
 const availableRegions = new Set();
 const RESIDENTIAL_REGEX = /(å®¶å®½|åŸç”Ÿ|residential|home)/i;
 const LOW_RATE_REGEX = /(ä½å€ç‡|lowrate|ä½-rate|å€ç‡)/i;

 // è¯†åˆ«å½’å±åœ°åŒº
 params.proxies.forEach(proxy => {
 const region = COUNTRY_REGIONS.find(r => r.regex.test(proxy.name));
 region ? availableRegions.add(region.name) : null;
 });

 // è·å–ç‰¹æ®ŠèŠ‚ç‚¹ç±»å‹
 const residentialProxies = getProxiesByRegex(params, RESIDENTIAL_REGEX);
 const lowRateProxies = getProxiesByRegex(params, LOW_RATE_REGEX);
 const hasResidential = residentialProxies.length > 0;
 const hasLowRate = lowRateProxies.length > 0;

 // æ£€æŸ¥å…¶ä»–åœ°åŒºèŠ‚ç‚¹
 const otherProxies = params.proxies
 .filter(proxy =>
 !COUNTRY_REGIONS.some(region => region.regex.test(proxy.name)) &&
 !RESIDENTIAL_REGEX.test(proxy.name) &&
 !LOW_RATE_REGEX.test(proxy.name)
 )
 .map(proxy => proxy.name);
 const hasOtherProxies = otherProxies.length > 0;

 return {
 allProxies,
 availableRegions,
 residentialProxies,
 lowRateProxies,
 hasResidential,
 hasLowRate,
 hasOtherProxies
 };
}

/**
 * åˆ›å»ºåŸºç¡€é€‰é¡¹æ•°ç»„ - é¿å…ç­–ç•¥ç»„é—´çš„å¾ªç¯å¼•ç”¨
*/
function createBaseOptions(COUNTRY_REGIONS, availableRegions, hasResidential, hasLowRate, hasOtherProxies = false) {
 const baseOptions = [
 ...COUNTRY_REGIONS.filter(r => availableRegions.has(r.name)).map(r => `${r.name} Â· è‡ªåŠ¨é€‰æ‹©`),
 "å»¶è¿Ÿä¼˜é€‰",
 "æ•…éšœè½¬ç§»",
 ...(hasResidential ? [RESIDENTIAL_LINE] : []),
 ...(hasLowRate ? [LOW_RATE_NODE] : []),
 "DIRECT",
 "REJECT"
 ];

 if (hasOtherProxies) {
 baseOptions.splice(COUNTRY_REGIONS.filter(r => availableRegions.has(r.name)).length + 2, 0, "å…¶ä»–åœ°åŒº Â· æ‰‹åŠ¨é€‰æ‹©");
 }

 return baseOptions;
}

// ===================== ç­–ç•¥ç»„åˆ›å»ºå‡½æ•° =====================
// æ³¨æ„ï¼šä»¥ä¸‹ä¸ºæ¡†æ¶ç¤ºä¾‹ï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦å®ç°å…·ä½“é€»è¾‘

/**
 * åˆ›å»ºæ ¸å¿ƒç­–ç•¥ç»„ - é…ç½®çš„æ ¸å¿ƒå…¥å£
*/
function createCoreGroups(allProxies, COUNTRY_REGIONS, availableRegions, hasResidential, hasLowRate) {
 // TODO: å®ç°æ ¸å¿ƒç­–ç•¥ç»„åˆ›å»ºé€»è¾‘
 return [];
}

/**
 * åˆ›å»ºåœ°åŒºå…¥å£ç­–ç•¥ç»„ - æä¾›ç”¨æˆ·é€‰æ‹©åœ°åŒºçš„ç»Ÿä¸€å…¥å£
*/
function createRegionEntryGroups(COUNTRY_REGIONS, availableRegions, hasResidential, hasLowRate) {
 // TODO: å®ç°åœ°åŒºå…¥å£ç­–ç•¥ç»„åˆ›å»ºé€»è¾‘
 return [];
}

/**
 * åˆ›å»ºåœ°åŒºç­–ç•¥ç»„ - åˆ›å»ºå…·ä½“åœ°åŒºçš„ç­–ç•¥ç»„
*/
function createRegionalGroups(params, COUNTRY_REGIONS, availableRegions) {
 // TODO: å®ç°åœ°åŒºç­–ç•¥ç»„åˆ›å»ºé€»è¾‘
 return { autoSelectGroups: [], manualSelectGroups: [], otherAutoGroup: null, otherManualGroup: null };
}

/**
 * åˆ›å»ºçº¿è·¯ç‰¹æ€§ç­–ç•¥ç»„ - ç‰¹æ®Šçº¿è·¯ç±»å‹ç­–ç•¥ç»„
*/
function createLineTypeGroups(hasResidential, residentialProxies, hasLowRate, lowRateProxies) {
 // TODO: å®ç°çº¿è·¯ç‰¹æ€§ç­–ç•¥ç»„åˆ›å»ºé€»è¾‘
 return [];
}

/**
 * åˆ›å»ºè‡ªå®šä¹‰è§„åˆ™ç­–ç•¥ç»„ - ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™çš„ç­–ç•¥ç»„
*/
function createCustomRuleGroups(COUNTRY_REGIONS, availableRegions, hasResidential, hasLowRate, hasOtherProxies) {
 // TODO: å®ç°è‡ªå®šä¹‰è§„åˆ™ç­–ç•¥ç»„åˆ›å»ºé€»è¾‘
 return [];
}

/**
 * åˆ›å»ºé»˜è®¤è·¯ç”±ç­–ç•¥ç»„ - æœ€ç»ˆé»˜è®¤è·¯ç”±ç­–ç•¥ç»„
*/
function createDefaultRouteGroups(COUNTRY_REGIONS, availableRegions, hasResidential, hasLowRate, hasOtherProxies) {
 // TODO: å®ç°é»˜è®¤è·¯ç”±ç­–ç•¥ç»„åˆ›å»ºé€»è¾‘
 return [];
}

// ===================== è§„åˆ™é…ç½®æ¨¡å— =====================
/**
 * è¦†ç›–è§„åˆ™é…ç½® - é…ç½®è§„åˆ™åŒ¹é…é¡ºåº
 * @param {Object} params - é…ç½®å‚æ•°å¯¹è±¡
*/
function overwriteRules(params) {
 // è‡ªå®šä¹‰è§„åˆ™æ·»åŠ åŒºåŸŸ
 const customRules = [
 // "DOMAIN-SUFFIX,example.com,ä»£ç†æ¨¡å¼" // ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™ç¤ºä¾‹
 ];

 // è·å–ç­–ç•¥ç»„çŠ¶æ€
 const hasResidential = params.__hasResidential || false;
 const hasLowRate = params.__hasLowRate || false;

 // æ„å»ºè§„åˆ™æ•°ç»„
 const rules = [
 // ç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™
 ...customRules,

 // åŸºç¡€è·¯ç”±è§„åˆ™
 "GEOSITE,private,DIRECT",
 "GEOIP,private,DIRECT,no-resolve",
 "GEOSITE,cn,DIRECT",
 "GEOIP,cn,DIRECT,no-resolve",

 // æœ€ç»ˆåŒ¹é…è§„åˆ™
 `GEOIP,CN,${DOMESTIC_TRAFFIC}`,
 `MATCH,${GLOBAL_TRAFFIC}`
 ];

 // åº”ç”¨è§„åˆ™æ•°ç»„
 params.rules = rules;
 // é…ç½®è§„åˆ™æä¾›å™¨
 params["rule-providers"] = createRuleProviders();
}

/**
 * åˆ›å»ºè§„åˆ™æä¾›å™¨é…ç½® - é…ç½®å¤–éƒ¨è§„åˆ™é›†
 * @return {Object} è§„åˆ™æä¾›å™¨é…ç½®å¯¹è±¡
*/
function createRuleProviders() {
 // æ£€æŸ¥ç¼“å­˜
 if (CACHE.ruleProviders) {
 return CACHE.ruleProviders;
 }

 /**
 * åˆ›å»ºè§„åˆ™æä¾›å™¨é…ç½®çš„è¾…åŠ©å‡½æ•°
 * @param {string} url - è§„åˆ™é›†URL
 * @param {string} path - æœ¬åœ°å­˜å‚¨è·¯å¾„
 * @param {number} interval - æ›´æ–°é—´éš”ï¼ˆç§’ï¼‰
 * @return {Object} è§„åˆ™æä¾›å™¨é…ç½®
 */
 function createRuleProviderConfig(url, path, interval = CONFIG_MANAGER.UPDATE_INTERVALS.DEFAULT) {
 return {
 type: "http", // HTTPç±»å‹è§„åˆ™é›†
 behavior: "classical", // ç»å…¸è§„åˆ™è¡Œä¸º
 format: "yaml", // YAMLæ ¼å¼
 interval: interval, // æ›´æ–°é—´éš”
 url: url, // è§„åˆ™URL
 path: path // æœ¬åœ°å­˜å‚¨è·¯å¾„
 };
 }

 const providers = {
 // è‡ªå®šä¹‰è§„åˆ™é›†ç¤ºä¾‹
 CustomProxyRules: {
 type: "http",
 behavior: "classical",
 format: "text",
 interval: CONFIG_MANAGER.UPDATE_INTERVALS.STATIC,
 url: "ä½ çš„è‡ªå®šä¹‰è§„åˆ™URL",
 path: "./ruleset/custom-proxy.yaml"
 }
 };

 // å­˜å‚¨åˆ°ç¼“å­˜
 CACHE.ruleProviders = providers;
 return providers;
}

// ===================== è¾…åŠ©å‡½æ•° =====================
/**
 * åˆ›å»ºä»£ç†ç»„ - ç­–ç•¥ç»„å·¥å‚æ–¹æ³•
 * @param {string} name - ç­–ç•¥ç»„åç§°
 * @param {string} type - ç­–ç•¥ç»„ç±»å‹
 * @param {Object} options - ç­–ç•¥ç»„é€‰é¡¹
 * @return {Object} ç­–ç•¥ç»„å¯¹è±¡
*/
function createProxyGroup(name, type, options = {}) {
 const base = {
 name, // ç­–ç•¥ç»„åç§°
 type, // ç­–ç•¥ç»„ç±»å‹
 category: options.category || "æœªåˆ†ç±»", // ç­–ç•¥ç»„åˆ†ç±»
 url: type !== "select" ? CONFIG_MANAGER.TEST_URL : undefined,
 interval: type !== "select" ? 600 : undefined
 };

 // è´Ÿè½½å‡è¡¡ç‰¹æ®Šå¤„ç†
 if (type === "load-balance") {
 Object.assign(options, {
 "max-failed-times": 3,
 lazy: true
 });
 }

 return Object.assign(base, options);
}

/**
 * æ ¹æ®æ­£åˆ™è¡¨è¾¾å¼è·å–ä»£ç†èŠ‚ç‚¹
 * @param {Object} params - é…ç½®å‚æ•°å¯¹è±¡
 * @param {RegExp} regex - åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼
 * @param {Array} fallback - å¤‡é€‰èŠ‚ç‚¹æ•°ç»„
 * @return {Array} åŒ¹é…çš„ä»£ç†èŠ‚ç‚¹åç§°æ•°ç»„
*/
function getProxiesByRegex(params, regex, fallback = ["DIRECT"]) {
 const matched = params.proxies
 .filter(e => regex.test(e.name))
 .map(e => e.name);
 return matched.length ? matched : fallback;
}

// ===================== DNSé…ç½®æ¨¡å— =====================
/**
 * è¦†ç›–DNSé…ç½® - DNSè§£æç›¸å…³å‚æ•°
 * @param {Object} params - é…ç½®å‚æ•°å¯¹è±¡
*/
function overwriteDns(params) {
 params.dns = {
 enable: true, // å¯ç”¨DNSåŠŸèƒ½
 listen: "0.0.0.0:1053", // ç›‘å¬åœ°å€å’Œç«¯å£
 "enhanced-mode": "fake-ip", // å¢å¼ºæ¨¡å¼ä¸ºè™šå‡IP
 "fake-ip-range": "198.18.0.1/16", // è™šå‡IPèŒƒå›´
 "use-hosts": false, // ä¸ä½¿ç”¨hostsæ–‡ä»¶
 "use-system-hosts": false, // ä¸ä½¿ç”¨ç³»ç»Ÿhostsæ–‡ä»¶
 ipv6: false, // ç¦ç”¨IPv6 DNSè§£æ
 "fake-ip-filter": [ // è™šå‡IPè¿‡æ»¤åˆ—è¡¨
 "*.lan", "*.local", // å±€åŸŸç½‘åŸŸå
 "time.*.com", "ntp.*.com" // æ—¶é—´åŒæ­¥åŸŸå
 ],
 "default-nameserver": ["tls://223.5.5.5"], // é»˜è®¤DNSæœåŠ¡å™¨
 nameserver: [ // ä¸»è¦DNSæœåŠ¡å™¨
 "https://dns.alidns.com/dns-query", // é˜¿é‡ŒDNS
 "https://doh.pub/dns-query" // DNSPod DNS
 ],
 "proxy-server-nameserver": [ // ä»£ç†æœåŠ¡å™¨DNS
 'https://1.1.1.1/dns-query', // Cloudflare DNS
 'https://223.5.5.5/dns-query' // é˜¿é‡ŒDNS
 ],
 "nameserver-policy": { // DNSç­–ç•¥
 'geosite:private': 'system', // ç§æœ‰åŸŸåä½¿ç”¨ç³»ç»ŸDNS
 'geosite:cn': ['119.29.29.29', '223.5.5.5'] // å›½å†…åŸŸåä½¿ç”¨å›½å†…DNS
 }
 };
}

// ===================== TUNé…ç½®æ¨¡å— =====================
/**
 * è¦†ç›–TUNé…ç½® - TUNéš§é“ç›¸å…³å‚æ•°
 * @param {Object} params - é…ç½®å‚æ•°å¯¹è±¡
*/
function overwriteTunnel(params) {
 params.tun = {
 enable: true, // å¯ç”¨TUNåŠŸèƒ½
 stack: "mixed", // æ··åˆåè®®æ ˆ
 device: "Mihomo", // TUNè®¾å¤‡åç§°
 "dns-hijack": ["any:53"], // DNSåŠ«æŒé…ç½®
 "auto-route": true, // è‡ªåŠ¨è·¯ç”±
 "auto-redirect": false, // ä¸è‡ªåŠ¨é‡å®šå‘
 "auto-detect-interface": true, // è‡ªåŠ¨æ£€æµ‹ç½‘ç»œæ¥å£
 "strict-route": false, // ä¸ä½¿ç”¨ä¸¥æ ¼è·¯ç”±
 "route-exclude-address": [], // è·¯ç”±æ’é™¤åœ°å€åˆ—è¡¨
 mtu: 1500 // æœ€å¤§ä¼ è¾“å•å…ƒ
 };
}
```

### 3.1 æ ¸å¿ƒæ¡†æ¶ä½¿ç”¨è¯´æ˜

#### 3.1.1 æ¡†æ¶ç‰¹ç‚¹

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šæ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•
2. **é…ç½®ä¸­å¿ƒåŒ–**ï¼šæ‰€æœ‰å¯é…ç½®å‚æ•°é›†ä¸­åœ¨CONFIG_MANAGERä¸­
3. **ç¼“å­˜æœºåˆ¶**ï¼šé¿å…é‡å¤è®¡ç®—ï¼Œæé«˜æ€§èƒ½
4. **æ‰©å±•å‹å¥½**ï¼šæä¾›æ¸…æ™°çš„æ‰©å±•ç‚¹å’Œç¤ºä¾‹

#### 3.1.2 ä½¿ç”¨æ–¹æ³•

1. **å¤åˆ¶æ ¸å¿ƒæ¡†æ¶**åˆ°æ–°çš„é…ç½®æ–‡ä»¶
2. **æ ¹æ®éœ€æ±‚å®ç°TODOéƒ¨åˆ†**çš„ç­–ç•¥ç»„åˆ›å»ºå‡½æ•°
3. **ä¿®æ”¹CONFIG_MANAGERä¸­çš„å‚æ•°**ä»¥é€‚åº”å…·ä½“ç¯å¢ƒ
4. **æ·»åŠ è‡ªå®šä¹‰è§„åˆ™å’Œç­–ç•¥ç»„**åˆ°ç›¸åº”ä½ç½®

#### 3.1.3 æ‰©å±•ç¤ºä¾‹

æ·»åŠ æ–°çš„åœ°åŒºæ”¯æŒçš„å®Œæ•´æµç¨‹ï¼š

```javascript
// 1. åœ¨createRegionalConfigä¸­æ·»åŠ 
{
 code: "KR",
 name: "éŸ©å›½",
 regex: /(éŸ©å›½|KR|Korea|ğŸ‡°ğŸ‡·)/i
}

// 2. æ·»åŠ ç›¸å…³å¸¸é‡å’Œé…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰
const KOREA_SERVICE = "éŸ©å›½æœåŠ¡";

// 3. åœ¨ç›¸åº”ç­–ç•¥ç»„åˆ›å»ºå‡½æ•°ä¸­æ·»åŠ å¤„ç†é€»è¾‘
// 4. åœ¨è§„åˆ™é…ç½®ä¸­æ·»åŠ ç›¸å…³è§„åˆ™
```

è¿™ä¸ªç²¾ç®€çš„æ ¸å¿ƒæ¡†æ¶ä¸ºç”¨æˆ·æä¾›äº†æ¸…æ™°çš„ç»“æ„å’Œæ‰©å±•æŒ‡å¯¼ï¼Œä¾¿äºå¿«é€Ÿæ„å»ºç¬¦åˆéœ€æ±‚çš„Clashé…ç½®ã€‚
